- hosts: all
  become: false
  gather_facts: false

  vars_files:
    - vars/defaults.yml

  tasks:
    # - name: Ping the machine
    #   ping:
    
    - name: Configure repository
      become: true
      yum_repository:
        name: docker
        description: Docker repository
        baseurl: https://download.docker.com/linux/centos/7/x86_64/stable
        gpgkey: https://download.docker.com/linux/centos/gpg

    - name: Install EPEL
      become: true
      yum:
        name: epel-release

    - name: Install docker and dependencies
      become: true
      yum:
        name:
          - "docker-ce"
          - python-virtualenv
          - python-pip
          - gcc # to satisfy subprocess32

    - name: Upgrade pip
      become: true
      pip:
        name: pip
        state: latest

    - name: Install Docker Module for Python
      pip:
        name: docker

    - name: Pull default Docker image
      docker_image:
        name: "{{ default_container_image }}"
        source: pull

    - name: Start and enable the Docker daemon
      service: 
        name: docker
        state: started
        enabled: yes
      become: true

    # Creates the number of containers defined by the variable create_containers, using values from vars file
    - name: Create default containers
      docker_container:
        name: "{{ default_container_name }}{{ item }}"
        image: "{{ default_container_image }}"
        command: "{{ default_container_command }}"
        state: present
      with_sequence: count={{ create_containers }}

